<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C - Visualizador 3D</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    touch-action: none;
  }

  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    z-index: 999;
    max-width: 400px;
  }

  button {
    padding: 10px 14px;
    margin-right: 5px;
    margin-bottom: 5px;
    cursor: pointer;
    background: white;
    border: 2px solid #333;
    border-radius: 4px;
    font-size: 14px;
    touch-action: manipulation;
  }

  button:hover {
    background: #f0f0f0;
  }

  button.active {
    background: #4CAF50;
    color: white;
  }

  button.ar-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  button.ar-button:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  }

  #panel {
    margin-top: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 8px;
    max-height: 70vh;
    overflow-y: auto;
  }

  #panel h3 {
    margin-top: 0;
    color: #4CAF50;
    font-size: 18px;
  }

  #instrucciones {
    margin-top: 10px;
    font-size: 11px;
    color: #ccc;
    line-height: 1.4;
  }

  #audioPanel {
    margin-top: 10px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }

  #audioPanel h4 {
    margin: 0 0 10px 0;
    color: #4CAF50;
    font-size: 16px;
  }

  .audio-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
  }

  .audio-controls button {
    flex: 1;
    padding: 10px;
    font-size: 13px;
    margin: 0;
  }

  #progressContainer {
    width: 100%;
    height: 8px;
    background: #333;
    border-radius: 4px;
    margin: 10px 0;
    cursor: pointer;
    position: relative;
    touch-action: none;
  }

  #progressBar {
    height: 100%;
    background: #4CAF50;
    border-radius: 4px;
    width: 0%;
    transition: width 0.1s;
  }

  #timeDisplay {
    font-size: 13px;
    color: #ccc;
    text-align: center;
  }

  .info-buttons {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  .info-buttons button {
    flex: 1 1 calc(50% - 5px);
    font-size: 12px;
    padding: 8px 10px;
    margin: 0;
  }

  #infoContent {
    margin-top: 10px;
    padding: 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    font-size: 14px;
    line-height: 1.5;
    max-height: 250px;
    overflow-y: auto;
  }

  #infoContent h4 {
    margin: 0 0 8px 0;
    color: #FFD700;
    font-size: 15px;
  }

  #infoContent::-webkit-scrollbar {
    width: 8px;
  }

  #infoContent::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
  }

  #infoContent::-webkit-scrollbar-thumb {
    background: #4CAF50;
    border-radius: 4px;
  }

  #panel::-webkit-scrollbar {
    width: 8px;
  }

  #panel::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.3);
    border-radius: 4px;
  }

  #panel::-webkit-scrollbar-thumb {
    background: #4CAF50;
    border-radius: 4px;
  }

  #animalTitle {
    background: rgba(76, 175, 80, 0.9);
    color: white;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 5px;
    text-align: center;
    font-weight: bold;
    font-size: 14px;
  }

  #arModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #arModal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 450px;
    text-align: center;
  }

  .modal-content h2 {
    color: #667eea;
    margin-top: 0;
  }

  .modal-content p {
    color: #333;
    line-height: 1.6;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .modal-buttons button {
    flex: 1;
    padding: 12px;
    font-size: 14px;
    margin: 0;
  }

  .btn-cancel {
    background: #ccc;
  }

  .btn-confirm {
    background: #667eea;
    color: white;
    border: none;
  }

  #arInstructions {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
    max-width: 90%;
    backdrop-filter: blur(10px);
    z-index: 998;
    display: none;
  }

  .ar-badge {
    background: rgba(255, 152, 0, 0.9);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 5px;
  }

  #surfaceIndicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    border: 3px dashed #4CAF50;
    border-radius: 50%;
    background: rgba(76, 175, 80, 0.2);
    display: none;
    z-index: 997;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.5; }
  }

  @media (max-width: 768px) {
    #ui {
      max-width: calc(100% - 20px);
    }

    button {
      font-size: 13px;
      padding: 9px 12px;
    }

    #panel h3 {
      font-size: 16px;
    }

    #infoContent {
      font-size: 13px;
      max-height: 200px;
    }

    .info-buttons button {
      font-size: 11px;
      padding: 7px 8px;
    }

    #instrucciones {
      font-size: 10px;
    }

    .modal-content {
      margin: 20px;
      padding: 20px;
    }
  }

  body.ar-mode #ui {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 10px;
  }

  body.ar-mode #arInstructions {
    display: block;
  }
</style>

</head>

<body>

<!-- Indicador de superficie -->
<div id="surfaceIndicator"></div>

<!-- ESCENA -->
<a-scene 
  id="normalScene" 
  webxr="requiredFeatures: hit-test,local-floor; optionalFeatures: dom-overlay,unbounded; overlayElement: #ui;"
  renderer="colorManagement: true; physicallyCorrectLights: true;">
  
  <a-assets>
    <img id="hdr" src="fondoblur.jpg">
    <audio id="sound-coati" src="sounds/coati.mp3" preload="auto"></audio>
  </a-assets>
  
  <a-sky src="#hdr"></a-sky>

  <a-light type="ambient" intensity="1.5"></a-light>
  <a-light type="directional" intensity="1.8" position="2 4 2"></a-light>

  <!-- Reticle para AR (invisible en modo normal) -->
  <a-entity
    id="reticle"
    geometry="primitive: ring; radiusInner: 0.08; radiusOuter: 0.1"
    material="color: #4CAF50; shader: flat; opacity: 0.8"
    rotation="-90 0 0"
    visible="false">
  </a-entity>

  <!-- Modelo del coati -->
  <a-entity
    id="modelo"
    gltf-model="models/coati.glb"
    position="0 0 0"
    scale="5 5 5"
    rotation="0 0 0">
  </a-entity>

  <!-- Suelo (solo visible en modo normal) -->
  <a-entity
    id="ground"
    gltf-model="models/ground.glb"
    position="0 -1.8 0"
    scale="3 3 3"
    rotation="0 0 0">
  </a-entity>

  <!-- C√°mara para modo normal -->
  <a-entity id="cameraRig" rotation="0 0 0">
    <a-camera
      position="0 0.5 4"
      look-controls="enabled: false"
      wasd-controls="enabled: true">
    </a-camera>
  </a-entity>
</a-scene>

<!-- Modal de confirmaci√≥n AR -->
<div id="arModal">
  <div class="modal-content">
    <h2>üéØ Modo Realidad Aumentada</h2>
    <p>El modo AR te permitir√° ver el modelo en tu entorno real.</p>
    <ul style="text-align: left; color: #666;">
      <li>üì± Apunta tu c√°mara al suelo</li>
      <li>üëÜ Toca donde quieras colocar el modelo</li>
      <li>üîÑ Mueve tu c√°mara para verlo desde todos los √°ngulos</li>
    </ul>
    <p style="font-size: 12px; color: #999;">
      <strong>Requisitos:</strong> Android con ARCore (Chrome/Edge)
    </p>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="cerrarModalAR()">Cancelar</button>
      <button class="btn-confirm" onclick="confirmarAR()">Activar AR</button>
    </div>
  </div>
</div>

<!-- Instrucciones AR -->
<div id="arInstructions">
  <div class="ar-badge">üéØ MODO AR ACTIVO</div>
  <div id="arInstructionText">
    <strong id="arStatusText">Buscando superficies...</strong><br>
    <small id="arHelpText">Apunta tu c√°mara al suelo y mu√©vela lentamente</small>
  </div>
  <button onclick="salirModoAR()" style="margin-top: 10px; padding: 8px 15px; background: rgba(255,255,255,0.9); border: none; border-radius: 5px; cursor: pointer;">
    üîô Salir de AR
  </button>
</div>

<!-- UI Principal -->
<div id="ui">
  <div id="animalTitle">ü¶° Coat√≠</div>

  <button onclick="togglePanel()">‚ÑπÔ∏è Informaci√≥n</button>
  <button onclick="reproducirSonido()">üîä Sonido</button>
  <button class="ar-button" onclick="activarModoAR()" id="btnAR">üì± Modo AR</button>

  <div id="panel" style="display: none;">
    <h3 id="titulo"></h3>
    <p id="descripcion"></p>
    
    <div class="info-buttons">
      <button data-info="habitat" onclick="mostrarInfo('habitat')">üåç H√°bitat</button>
      <button data-info="alimentacion" onclick="mostrarInfo('alimentacion')">üçÉ Alimentaci√≥n</button>
      <button data-info="conservacion" onclick="mostrarInfo('conservacion')">üõ°Ô∏è Conservaci√≥n</button>
    </div>
    
    <div id="infoContent" style="display: none;"></div>
    
    <div id="instrucciones">
      <strong>PC:</strong> WASD: Mover | Arrastrar: Rotar | Rueda: Zoom<br>
      <strong>M√≥vil:</strong> Deslizar: Rotar | Pinch: Zoom<br>
      <strong>AR:</strong> Detecci√≥n de superficies y colocaci√≥n t√°ctil
    </div>
  </div>

  <div id="audioPanel">
    <h4 id="audioTitle">üîä Audio</h4>
    
    <div class="audio-controls">
      <button onclick="rebobinarAudio()">‚è™ -5s</button>
      <button id="playPauseBtn" onclick="togglePlayPause()">‚è∏Ô∏è Pausar</button>
      <button onclick="ocultarPanelAudio()">‚ùå Cerrar</button>
    </div>
    
    <div id="progressContainer" onclick="clickProgress(event)">
      <div id="progressBar"></div>
    </div>
    
    <div id="timeDisplay">0:00 / 0:00</div>
  </div>
</div>

<script>
  // VARIABLES GLOBALES
  let modoAR = false;
  let modeloColocado = false;
  let esMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  let xrHitTestSource = null;
  let hitTestSourceRequested = false;
  let reticleVisible = false;
  let lastHitPose = null;

  // ========================================
  // CONTROL DE ROTACI√ìN Y ZOOM (MODO NORMAL)
  // ========================================
  window.addEventListener('DOMContentLoaded', () => {
    const rig = document.querySelector('#cameraRig');
    const camera = document.querySelector('a-camera');

    if (!rig) {
      console.error('cameraRig no encontrado');
      return;
    }

    let dragging = false;
    let lastX = 0;
    let rotationY = 0;
    let zoom = 4;
    const cameraY = 0.5;

    // ===== EVENTOS DE MOUSE =====
    window.addEventListener('mousedown', e => {
      if (modoAR) return;
      if (e.target.closest('#ui')) return;
      dragging = true;
      lastX = e.clientX;
    });

    window.addEventListener('mouseup', () => dragging = false);

    window.addEventListener('mousemove', e => {
      if (modoAR) return;
      if (!dragging) return;

      const delta = e.clientX - lastX;
      lastX = e.clientX;

      rotationY += delta * 0.3;
      rig.setAttribute('rotation', `0 ${rotationY} 0`);
    });

    // ===== ZOOM CON RUEDA DEL MOUSE =====
    window.addEventListener('wheel', e => {
      if (modoAR) return;
      if (e.target.closest('#ui')) return;
      zoom += e.deltaY * 0.01;
      zoom = Math.min(Math.max(zoom, 2), 12);
      camera.setAttribute('position', `0 ${cameraY} ${zoom}`);
    });

    // ===== EVENTOS T√ÅCTILES =====
    window.addEventListener('touchstart', e => {
      if (modoAR) return;
      if (e.target.closest('#ui')) return;
      
      if (e.touches.length === 1) {
        dragging = true;
        lastX = e.touches[0].clientX;
      } else if (e.touches.length === 2) {
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
      }
    }, { passive: true });

    window.addEventListener('touchend', () => dragging = false);

    let lastDistance = 0;

    window.addEventListener('touchmove', e => {
      if (modoAR) return;
      
      if (e.touches.length === 1 && dragging) {
        const delta = e.touches[0].clientX - lastX;
        lastX = e.touches[0].clientX;
        rotationY += delta * 0.3;
        rig.setAttribute('rotation', `0 ${rotationY} 0`);
      } else if (e.touches.length === 2) {
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const distance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );

        const delta = lastDistance - distance;
        zoom += delta * 0.01;
        zoom = Math.min(Math.max(zoom, 2), 12);
        camera.setAttribute('position', `0 ${cameraY} ${zoom}`);
        lastDistance = distance;
      }
    }, { passive: false });
  });

  // ========================================
  // INFORMACI√ìN DEL ANIMAL
  // ========================================
  const animal = {
    nombre: "Coat√≠",
    descripcion: "El gato solo o coat√≠ es un mam√≠fero diurno de color marr√≥n y hocico alargado. Vive en grupos sociales de hasta 30 individuos, integrados principalmente por hembras, cr√≠as y machos juveniles.",
    habitat: "Su distribuci√≥n abarca desde el suroeste de Estados Unidos hasta el norte de Argentina, incluyendo M√©xico, Centroam√©rica y Panam√°. Generalmente se les encuentra en h√°bitats boscosos como bosques templados, selvas tropicales de tierras bajas y bosques nubosos.",
    alimentacion: "Son omn√≠voros. Su alimento predilecto son los insectos. Para hallarlos usan su desarrollado olfato que les permite olerlos debajo de la tierra.",
    conservacion: "Es una especie amenazada, debido a que las especies adultas son cazadas por cazadores de subsistencia, o cazadores-recolectores, para alimentarse por lo que muchas veces las cr√≠as quedan sobreviviendo solas."
  };

  let infoActiva = null;

  function mostrarAnimal() {
    document.getElementById('titulo').textContent = animal.nombre;
    document.getElementById('descripcion').textContent = animal.descripcion;
    
    if (infoActiva) {
      mostrarInfo(infoActiva);
    } else {
      document.getElementById('infoContent').style.display = 'none';
    }
  }

  function mostrarInfo(tipo) {
    const infoContent = document.getElementById('infoContent');
    
    let titulo = '';
    let contenido = '';
    
    if (infoActiva === tipo) {
      infoActiva = null;
      infoContent.style.display = 'none';
      actualizarBotonesInfo();
      return;
    }
    
    switch(tipo) {
      case 'habitat':
        titulo = 'üåç H√°bitat';
        contenido = animal.habitat;
        break;
      case 'alimentacion':
        titulo = 'üçÉ Alimentaci√≥n';
        contenido = animal.alimentacion;
        break;
      case 'conservacion':
        titulo = 'üõ°Ô∏è Estado de Conservaci√≥n';
        contenido = animal.conservacion;
        break;
    }
    
    infoContent.innerHTML = `<h4>${titulo}</h4><p>${contenido}</p>`;
    infoContent.style.display = 'block';
    infoActiva = tipo;
    actualizarBotonesInfo();
  }

  function actualizarBotonesInfo() {
    const botonesInfo = document.querySelectorAll('.info-buttons button');
    botonesInfo.forEach(btn => {
      const tipo = btn.getAttribute('data-info');
      if (tipo === infoActiva) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  function togglePanel() {
    const panel = document.getElementById('panel');
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
    } else {
      panel.style.display = 'none';
    }
  }

  // ========================================
  // MODO AR - FUNCIONES PRINCIPALES
  // ========================================
  function activarModoAR() {
    document.getElementById('arModal').classList.add('show');
  }

  function cerrarModalAR() {
    document.getElementById('arModal').classList.remove('show');
  }

  async function confirmarAR() {
    cerrarModalAR();
    
    if (!esMobile) {
      alert('‚ö†Ô∏è El modo AR con detecci√≥n de superficies solo est√° disponible en dispositivos m√≥viles Android con ARCore.');
      return;
    }

    try {
      if (!navigator.xr) {
        alert('‚ùå Tu dispositivo no soporta WebXR.\n\nNecesitas:\n- Android con ARCore\n- Chrome o Edge actualizado');
        return;
      }

      const supported = await navigator.xr.isSessionSupported('immersive-ar');
      
      if (!supported) {
        alert('‚ùå AR no disponible.\n\nRequisitos:\n- Android con Google Play Services para AR\n- Chrome/Edge actualizado');
        return;
      }

      modoAR = true;
      modeloColocado = false;
      hitTestSourceRequested = false;
      document.body.classList.add('ar-mode');
      
      // Ocultar elementos de modo normal
      const sky = document.querySelector('a-sky');
      const ground = document.querySelector('#ground');
      if (sky) sky.setAttribute('visible', false);
      if (ground) ground.setAttribute('visible', false);
      
      // Ocultar modelo hasta que se coloque
      const modelo = document.querySelector('#modelo');
      modelo.setAttribute('visible', false);
      modelo.setAttribute('scale', '1.5 1.5 1.5');
      
      // Mostrar instrucciones AR
      document.getElementById('arInstructions').style.display = 'block';
      
      // Entrar en modo AR
      const scene = document.querySelector('a-scene');
      await scene.enterAR();
      
      console.log('‚úÖ Modo AR activado');
      
    } catch (error) {
      console.error('Error al activar AR:', error);
      alert('‚ùå Error al iniciar AR:\n' + error.message);
      salirModoAR();
    }
  }

  function salirModoAR() {
    const scene = document.querySelector('a-scene');
    
    if (scene.is('ar-mode')) {
      scene.exitAR();
    }
    
    modoAR = false;
    modeloColocado = false;
    hitTestSourceRequested = false;
    reticleVisible = false;
    document.body.classList.remove('ar-mode');
    
    // Restaurar visibilidad
    const sky = document.querySelector('a-sky');
    const ground = document.querySelector('#ground');
    const reticle = document.querySelector('#reticle');
    
    if (sky) sky.setAttribute('visible', true);
    if (ground) ground.setAttribute('visible', true);
    if (reticle) reticle.setAttribute('visible', false);
    
    // Restaurar modelo
    const modelo = document.querySelector('#modelo');
    modelo.setAttribute('scale', '5 5 5');
    modelo.setAttribute('position', '0 0 0');
    modelo.setAttribute('visible', true);
    
    // Ocultar UI de AR
    document.getElementById('arInstructions').style.display = 'none';
    document.getElementById('surfaceIndicator').style.display = 'none';
    
    // Limpiar hit-test
    if (xrHitTestSource) {
      xrHitTestSource.cancel();
      xrHitTestSource = null;
    }
    
    console.log('‚úÖ Salido del modo AR');
  }

  // ========================================
  // AR HIT-TEST - DETECCI√ìN DE SUPERFICIES
  // ========================================
  const scene = document.querySelector('a-scene');
  
  scene.addEventListener('enter-vr', async () => {
    if (!scene.is('ar-mode')) return;
    
    console.log('üéØ Entrando en sesi√≥n AR...');
    
    const renderer = scene.renderer;
    const session = renderer.xr.getSession();
    
    if (!session) {
      console.error('‚ùå No hay sesi√≥n XR');
      return;
    }

    // Iniciar el loop de hit-test
    renderer.xr.addEventListener('sessionstart', () => {
      session.requestReferenceSpace('viewer').then((refSpace) => {
        session.requestHitTestSource({ space: refSpace }).then((hitTestSource) => {
          xrHitTestSource = hitTestSource;
          hitTestSourceRequested = true;
          console.log('‚úÖ Hit-test source inicializado');
        }).catch(err => {
          console.error('‚ùå Error al crear hit-test source:', err);
        });
      });
    });

    // Loop de renderizado para detecci√≥n continua
    function onXRFrame(time, frame) {
      if (!modoAR) return;
      if (!frame) return;
      if (modeloColocado) return;

      const session = frame.session;
      
      if (xrHitTestSource && hitTestSourceRequested) {
        const hitTestResults = frame.getHitTestResults(xrHitTestSource);
        
        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(renderer.xr.getReferenceSpace());
          
          if (pose) {
            const reticle = document.querySelector('#reticle');
            
            // Actualizar posici√≥n del reticle
            reticle.setAttribute('position', {
              x: pose.transform.position.x,
              y: pose.transform.position.y,
              z: pose.transform.position.z
            });
            
            if (!reticleVisible) {
              reticle.setAttribute('visible', true);
              reticleVisible = true;
            }
            
            // Guardar √∫ltima pose v√°lida
            lastHitPose = pose;
            
            // Actualizar UI
            document.getElementById('surfaceIndicator').style.display = 'block';
            document.getElementById('arStatusText').textContent = '‚úÖ Superficie detectada';
            document.getElementById('arHelpText').textContent = 'Toca la pantalla para colocar el modelo';
          }
        } else {
          // No hay superficies detectadas
          const reticle = document.querySelector('#reticle');
          if (reticleVisible) {
            reticle.setAttribute('visible', false);
            reticleVisible = false;
          }
          
          document.getElementById('surfaceIndicator').style.display = 'none';
          document.getElementById('arStatusText').textContent = 'Buscando superficies...';
          document.getElementById('arHelpText').textContent = 'Apunta tu c√°mara al suelo y mu√©vela lentamente';
        }
      }

      session.requestAnimationFrame(onXRFrame);
    }

    session.requestAnimationFrame(onXRFrame);
  });

  scene.addEventListener('exit-vr', () => {
    if (modoAR) {
      salirModoAR();
    }
  });

  // ========================================
  // COLOCACI√ìN DEL MODELO EN AR
  // ========================================
  window.addEventListener('touchend', (e) => {
    if (!modoAR) return;
    if (modeloColocado) return;
    if (e.target.closest('#ui')) return;
    if (e.target.closest('#arInstructions')) return;
    
    if (lastHitPose) {
      colocarModelo(lastHitPose);
    }
  });

  function colocarModelo(pose) {
    const modelo = document.querySelector('#modelo');
    const reticle = document.querySelector('#reticle');
    
    // Posicionar el modelo donde est√° el reticle
    modelo.setAttribute('position', {
      x: pose.transform.position.x,
      y: pose.transform.position.y,
      z: pose.transform.position.z
    });
    
    // Hacer visible el modelo
    modelo.setAttribute('visible', true);
    
    // Ocultar reticle
    reticle.setAttribute('visible', false);
    
    modeloColocado = true;
    reticleVisible = false;
    
    // Actualizar UI
    document.getElementById('surfaceIndicator').style.display = 'none';
    document.getElementById('arStatusText').textContent = '‚úÖ Modelo colocado';
    document.getElementById('arHelpText').textContent = 'Mueve tu c√°mara para verlo desde diferentes √°ngulos';
    
    console.log('‚úÖ Modelo colocado en:', pose.transform.position);
  }

  // ========================================
  // AUDIO DEL COATI
  // ========================================
  let audioActual = null;
  let isPlaying = false;

  function reproducirSonido() {
    const sound = document.querySelector('#sound-coati');
    
    if (sound) {
      audioActual = sound;
      audioActual.play().catch(err => {
        console.log('Error al reproducir sonido:', err);
      });
      
      isPlaying = true;
      mostrarPanelAudio();
      actualizarBotonPlay();
    }
  }

  function mostrarPanelAudio() {
    const panel = document.getElementById('audioPanel');
    document.getElementById('audioTitle').textContent = `üîä ${animal.nombre}`;
    panel.style.display = 'block';
  }

  function ocultarPanelAudio() {
    document.getElementById('audioPanel').style.display = 'none';
    if (audioActual) {
      audioActual.pause();
      audioActual.currentTime = 0;
      isPlaying = false;
      actualizarBotonPlay();
    }
  }

  function togglePlayPause() {
    if (!audioActual) return;
    
    if (isPlaying) {
      audioActual.pause();
      isPlaying = false;
    } else {
      audioActual.play();
      isPlaying = true;
    }
    actualizarBotonPlay();
  }

  function rebobinarAudio() {
    if (!audioActual) return;
    audioActual.currentTime = Math.max(0, audioActual.currentTime - 5);
  }

  function actualizarBotonPlay() {
    const btn = document.getElementById('playPauseBtn');
    if (btn) {
      btn.textContent = isPlaying ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Reproducir';
    }
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Actualizar barra de progreso
  setInterval(() => {
    if (audioActual && isPlaying) {
      const progress = (audioActual.currentTime / audioActual.duration) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      
      const currentTime = formatTime(audioActual.currentTime);
      const duration = formatTime(audioActual.duration || 0);
      document.getElementById('timeDisplay').textContent = `${currentTime} / ${duration}`;
      
      if (audioActual.currentTime >= audioActual.duration) {
        isPlaying = false;
        actualizarBotonPlay();
      }
    }
  }, 100);

  function clickProgress(e) {
    if (!audioActual) return;
    
    const container = document.getElementById('progressContainer');
    const rect = container.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const percent = (clientX - rect.left) / rect.width;
    audioActual.currentTime = percent * audioActual.duration;
  }

  // ========================================
  // INICIALIZACI√ìN
  // ========================================
  document.addEventListener('DOMContentLoaded', () => {
    const progressContainer = document.getElementById('progressContainer');
    
    progressContainer.addEventListener('touchstart', e => {
      e.preventDefault();
      clickProgress(e);
    }, { passive: false });

    progressContainer.addEventListener('touchmove', e => {
      e.preventDefault();
      clickProgress(e);
    }, { passive: false });
    
    // Inicializar informaci√≥n
    mostrarAnimal();
  });
</script>

</body>
</html>